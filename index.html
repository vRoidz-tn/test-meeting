<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Meeting Room Booking</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body{
      margin:0;
      font-family:'Segoe UI',Tahoma,sans-serif;
      background:radial-gradient(circle at top,#6024b5 0%,#321464 100%);
      min-height:100vh;
      padding:20px;
      color:#eee;
    }
    .container{
      max-width:440px;
      margin:0 auto;
      background:rgba(25,20,50,0.85);
      border-radius:24px;
      box-shadow:0 0 25px rgba(150,80,255,.6);
      backdrop-filter:blur(6px);
    }
    .header{
      padding:25px;
      text-align:center;
      background:linear-gradient(45deg,#7938ff,#a45bff);
      border-top-left-radius:24px;
      border-top-right-radius:24px;
    }
    .header h2{margin:0;font-size:22px;color:#fff}
    .form-container{padding:24px}
    .form-group{margin-bottom:18px}
    label{display:block;margin-bottom:6px;font-weight:600}
    input{
      width:100%;
      padding:10px;
      border:2px solid #4b2d88;
      border-radius:10px;
      background:#1d1335;
      color:#eee;
      box-sizing:border-box;
    }
    input:focus{border-color:#9b6bff;outline:none}
    .intention-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .intention-option{
      padding:16px;
      text-align:center;
      background:#2c1b50;
      border:2px solid #4b2d88;
      border-radius:12px;
      cursor:pointer;
      transition:.2s;
    }
    .intention-option:hover{background:#3e2670}
    .intention-option.selected{
      background:#8e4fff;
      border-color:#c89fff;
      color:#fff;
    }
    .room-grid{display:grid;grid-template-columns:1fr;gap:10px}
    .room-option{
      padding:12px;
      border:2px solid #4b2d88;
      border-radius:10px;
      background:#241447;
      cursor:pointer;
      text-align:center;
      transition:.2s;
    }
    .room-option:hover{background:#352060}
    .room-option.selected{
      background:#8e4fff;
      border-color:#c89fff;
      color:#fff;
    }
    .time-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .submit-btn{
      width:100%;
      padding:12px;
      margin-top:14px;
      font-size:16px;
      font-weight:600;
      color:#fff;
      background:linear-gradient(45deg,#a45bff,#ff8cff);
      border:none;
      border-radius:10px;
      cursor:pointer;
      box-shadow:0 0 10px rgba(255,140,255,.4);
    }
    .back-btn{
      width:100%;
      padding:10px;
      background:#4b2d88;
      color:#fff;
      border:none;
      border-radius:10px;
      margin-top:8px;
      cursor:pointer;
    }
    #eventList .room-option{margin-bottom:8px}
    #log{
      background:#1e1238;
      border:1px solid #4b2d88;
      border-radius:8px;
      padding:10px;
      margin-top:15px;
      font-size:12px;
      max-height:150px;
      overflow-y:auto;
      display:none;
      color:#ccc;
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header"><h2>üí´ Meeting Room Booking</h2></div>
  <div class="form-container">

    <!-- Intent -->
    <div id="intentScreen">
      <label>üéØ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</label>
      <div class="intention-grid">
        <div class="intention-option" data-intent="book">üìù ‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á</div>
        <div class="intention-option" data-intent="check">üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</div>
        <div class="intention-option" data-intent="cancel">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</div>
        <div class="intention-option" data-intent="edit">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</div>
      </div>
    </div>

    <!-- Book -->
    <form id="mainForm" style="display:none">
      <div class="form-group">
        <label>üìã ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</label>
        <input id="title">
      </div>
      <div class="form-group">
        <label>üè† ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á</label>
        <div class="room-grid" id="roomGrid">
          <div class="room-option" data-room="evolve">Evolve Room ‚Äì 1F</div>
          <div class="room-option" data-room="strategic">Strategic Thinking ‚Äì 2F</div>
          <div class="room-option" data-room="teamwork">Teamwork ‚Äì 4F</div>
        </div>
      </div>
      <div class="form-group">
        <label>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
        <input type="date" id="date">
      </div>
      <div class="form-group">
        <label>‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤</label>
        <div class="time-row">
          <input type="time" id="start">
          <input type="time" id="end">
        </div>
      </div>
      <button type="submit" class="submit-btn">‡∏™‡πà‡∏á</button>
      <button type="button" class="back-btn" id="backBtn">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
    </form>

    <!-- Event list for cancel/edit -->
    <div id="eventList" style="display:none;margin-top:16px"></div>

    <!-- Edit -->
    <form id="editForm" style="display:none">
      <div class="form-group">
        <label>üìã ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</label>
        <input id="editTitle">
      </div>
      <label>üè† ‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</label>
      <div class="room-grid" id="newRoomGrid">
        <div class="room-option" data-room="evolve">Evolve Room ‚Äì 1F</div>
        <div class="room-option" data-room="strategic">Strategic Thinking ‚Äì 2F</div>
        <div class="room-option" data-room="teamwork">Teamwork ‚Äì 4F</div>
      </div>
      <label>üìÖ ‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡∏°‡πà</label>
      <div class="time-row">
        <input type="date" id="newDate">
        <input type="time" id="newStart">
        <input type="time" id="newEnd">
      </div>
      <button type="button" class="submit-btn" id="saveEditBtn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      <button type="button" class="back-btn" id="backFromEdit">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
    </form>

    <div id="log"><b>Debug:</b><div id="logContent"></div></div>
  </div>
</div>

<script>
const liffId='2007795446-LJyk3OJ3';
const appUrl='https://script.google.com/macros/s/AKfycbz4-1xgXRYjShI0DaEBMysHVSnGHKhvS30gbzgVvzsLptgu73qiRerqhhzqpwuviCAt/exec';

let intent=null,room=null,newRoom=null,user=null,selectedEvent=null;
const names={evolve:'Evolve Room',strategic:'Strategic Thinking Room',teamwork:'Teamwork Room'};

document.addEventListener('DOMContentLoaded',()=>{initLIFF();bindUI();});

function initLIFF(){
  liff.init({liffId}).then(()=>{
    if(liff.isInClient()) liff.getProfile().then(p=>user=p);
    const t=new Date().toISOString().split('T')[0];
    ['date','newDate'].forEach(id=>{const el=document.getElementById(id);if(el)el.value=t;});
  }).catch(console.error);
}

function bindUI(){
  document.querySelectorAll('.intention-option').forEach(el=>{
    el.onclick=()=>{intent=el.dataset.intent;selectIntent(el);};
  });
  document.querySelectorAll('#roomGrid .room-option').forEach(o=>{
    o.onclick=()=>{selectRoom(o,'roomGrid');room=o.dataset.room;};
  });
  document.querySelectorAll('#newRoomGrid .room-option').forEach(o=>{
    o.onclick=()=>{selectRoom(o,'newRoomGrid');newRoom=o.dataset.room;};
  });
  document.getElementById('mainForm').onsubmit=e=>{e.preventDefault();sendMain();};
  document.getElementById('saveEditBtn').onclick=sendEdit;
  document.getElementById('backBtn').onclick=()=>toggleForms(true);
  document.getElementById('backFromEdit').onclick=()=>toggleForms(true);
}

function selectIntent(el){
  document.querySelectorAll('.intention-option').forEach(i=>i.classList.remove('selected'));
  el.classList.add('selected');
  selectedEvent=null;
  toggleForms();
}

function selectRoom(el,grid){
  document.querySelectorAll('#'+grid+' .room-option').forEach(i=>i.classList.remove('selected'));
  el.classList.add('selected');
}

function toggleForms(back){
  document.getElementById('intentScreen').style.display=back?'block':'none';
  document.getElementById('mainForm').style.display=intent==='book'&&!back?'block':'none';
  document.getElementById('editForm').style.display=intent==='edit'&&!back&&selectedEvent?'block':'none';
  document.getElementById('eventList').style.display=(intent==='cancel'||intent==='edit')&&!back&&!selectedEvent?'block':'none';
  if((intent==='cancel'||intent==='edit')&&!back&&!selectedEvent) loadEvents();
  if(intent==='check'&&!back) sendCheck();
}

async function loadEvents(){
  try{
    const res=await fetch(`${appUrl}?userid=${user.userId}`);
    const data=await res.json(); // [{id,title,room,date,start,end}]
    const box=document.getElementById('eventList');
    box.innerHTML=data.map(ev=>`
      <div class="room-option" data-id="${ev.id}">
        <b>${ev.title}</b><br>${ev.room}<br>${ev.date} ${ev.start}-${ev.end}
      </div>`).join('');
    box.querySelectorAll('.room-option').forEach(div=>{
      div.onclick=()=>{selectEvent(div.dataset.id,data);};
    });
  }catch(e){alert('‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');}
}

function selectEvent(id,data){
  selectedEvent=data.find(e=>e.id===id);
  if(intent==='cancel'){
    const text=`Cancel Request\n‡πÄ‡∏û‡∏∑‡πà‡∏≠ '${selectedEvent.title}' ‡∏ó‡∏µ‡πà '${selectedEvent.room}' '${selectedEvent.date}' '${selectedEvent.start}'-'${selectedEvent.end}'`;
    sendMsg(text);
  }
  if(intent==='edit'){
    document.getElementById('editTitle').value=selectedEvent.title;
    document.getElementById('eventList').style.display='none';
    document.getElementById('editForm').style.display='block';
  }
}

function sendMain(){
  const title=document.getElementById('title').value.trim();
  const d=document.getElementById('date').value;
  const s=document.getElementById('start').value;
  const e=document.getElementById('end').value;
  const text=`Booking Request\n‡πÄ‡∏û‡∏∑‡πà‡∏≠ '${title}' ‡∏ó‡∏µ‡πà '${names[room]}' '${d}' '${s}'-'${e}'`;
  sendMsg(text);
}

function sendEdit(){
  const nd=document.getElementById('newDate').value;
  const ns=document.getElementById('newStart').value;
  const ne=document.getElementById('newEnd').value;
  const text=`Edit Request\n‡πÄ‡∏û‡∏∑‡πà‡∏≠ '${selectedEvent.title}' ‡∏ó‡∏µ‡πà '${selectedEvent.room}' '${selectedEvent.date}' '${selectedEvent.start}'-'${selectedEvent.end}' ‡πÄ‡∏õ‡πá‡∏ô '${names[newRoom]}' '${nd}' '${ns}'-'${ne}'`;
  sendMsg(text);
}

function sendCheck(){sendMsg('Check Request');}

function sendMsg(text){
  if(!liff.isInClient()){alert(text);return;}
  liff.sendMessages([{type:'text',text}])
      .then(()=>liff.closeWindow())
      .catch(e=>alert(e.message));
}
</script>
</body>
</html>
