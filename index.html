<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Meeting Room Booking</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body{margin:0;font-family:'Segoe UI',Tahoma,sans-serif;background:#2a1850;color:#eee;padding:20px}
    .container{max-width:440px;margin:0 auto;background:#1d1335;border-radius:20px;box-shadow:0 0 20px rgba(180,120,255,.5)}
    .header{padding:20px;text-align:center;background:linear-gradient(45deg,#7938ff,#a45bff);border-top-left-radius:20px;border-top-right-radius:20px}
    .header h2{margin:0;font-size:22px;color:#fff}
    .form-container{padding:20px}
    .form-group{margin-bottom:14px}
    label{display:block;margin-bottom:6px;font-weight:600}
    input{width:100%;padding:9px;border:2px solid #4b2d88;border-radius:8px;background:#2b1a4f;color:#eee;box-sizing:border-box}
    input:focus{border-color:#9b6bff;outline:none}

    .intention-grid{display:flex;gap:10px;margin-bottom:16px}
    .intention-option{flex:1;padding:14px;text-align:center;background:#3b2670;border:2px solid #4b2d88;border-radius:10px;cursor:pointer}
    .intention-option.selected{background:#8e4fff;border-color:#c89fff;color:#fff}

    .room-grid{display:grid;gap:8px}
    .room-option{padding:10px;border:2px solid #4b2d88;border-radius:8px;background:#29174b;cursor:pointer;text-align:center}
    .room-option:hover{background:#3d2472}
    .room-option.selected{background:#8e4fff;border-color:#c89fff;color:#fff}

    .time-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .submit-btn{width:100%;padding:12px;margin-top:12px;font-size:15px;font-weight:600;color:#fff;background:linear-gradient(45deg,#a45bff,#ff8cff);border:none;border-radius:8px;cursor:pointer}
    .back-btn{width:100%;padding:9px;background:#4b2d88;color:#fff;border:none;border-radius:8px;margin-top:8px;cursor:pointer}
    #eventList .room-option{margin-bottom:6px}
    #log{background:#120a28;border:1px solid #4b2d88;border-radius:6px;padding:8px;margin-top:12px;font-size:12px;max-height:150px;overflow-y:auto;color:#ccc}
  </style>
</head>
<body>
<div class="container">
  <div class="header"><h2>üí´ Meeting Room Booking</h2></div>
  <div class="form-container">

    <div id="intentScreen">
      <label>üéØ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</label>
      <div class="intention-grid">
        <div class="intention-option" data-intent="book">üìù ‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á</div>
        <div class="intention-option" data-intent="cancel">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</div>
        <div class="intention-option" data-intent="edit">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</div>
      </div>
    </div>

    <form id="mainForm" style="display:none">
      <div class="form-group">
        <label>üìã ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</label>
        <input id="title">
      </div>
      <div class="form-group">
        <label>üè† ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á</label>
        <div class="room-grid" id="roomGrid">
          <div class="room-option" data-room="evolve">Evolve Room - 1st floor</div>
          <div class="room-option" data-room="strategic">Strategic Thinking Room - 2nd floor</div>
          <div class="room-option" data-room="teamwork">Teamwork Room - 4th floor</div>
        </div>
      </div>
      <div class="form-group">
        <label>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
        <input type="date" id="date">
      </div>
      <div class="form-group">
        <label>‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤</label>
        <div class="time-row">
          <input type="time" id="start">
          <input type="time" id="end">
        </div>
      </div>
      <button type="submit" class="submit-btn">‡∏™‡πà‡∏á</button>
      <button type="button" class="back-btn" id="backBtn">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
    </form>

    <div id="eventList" style="display:none;margin-top:12px"></div>

    <form id="editForm" style="display:none">
      <div class="form-group">
        <label>üìã ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</label>
        <input id="editTitle">
      </div>
      <label>üè† ‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</label>
      <div class="room-grid" id="newRoomGrid">
        <div class="room-option" data-room="evolve">Evolve Room - 1st floor</div>
        <div class="room-option" data-room="strategic">Strategic Thinking Room - 2nd floor</div>
        <div class="room-option" data-room="teamwork">Teamwork Room - 4th floor</div>
      </div>
      <label>üìÖ ‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡∏°‡πà</label>
      <div class="time-row">
        <input type="date" id="newDate">
        <input type="time" id="newStart">
        <input type="time" id="newEnd">
      </div>
      <button type="button" class="submit-btn" id="saveEditBtn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      <button type="button" class="back-btn" id="backFromEdit">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
    </form>

    <div id="log"><b>Debug:</b><div id="logContent"></div></div>
  </div>
</div>

<script>
const liffId='2007795446-LJyk3OJ3';
const appUrl='https://script.google.com/macros/s/AKfycbx3AdztCYbCAUygSo4669BLcBrnE0Cqii5u1x8o6Aiwn8UUFe6_w4dtqT_PnsmRRsdf/exec';

let intent=null,room=null,newRoom=null,user=null,selectedEvent=null;
const names={
  evolve:'Evolve Room - 1st floor',
  strategic:'Strategic Thinking Room - 2nd floor',
  teamwork:'Teamwork Room - 4th floor'
};

document.addEventListener('DOMContentLoaded',()=>{initLIFF();bindUI();});

function log(m){
  const box=document.getElementById('log');
  const body=document.getElementById('logContent');
  const t=new Date().toLocaleTimeString();
  body.innerHTML+=`[${t}] ${m}<br>`;
  box.style.display='block';
}

function initLIFF(){
  liff.init({liffId}).then(()=>{
    if(liff.isInClient()){
      liff.getProfile().then(p=>{
        user=p;
        log('User loaded: '+user.userId);
      });
    }
    const today=new Date().toISOString().split('T')[0];
    ['date','newDate'].forEach(id=>{
      const el=document.getElementById(id);if(el)el.value=today;
    });
  }).catch(e=>log('LIFF init error: '+e));
}

function bindUI(){
  document.querySelectorAll('.intention-option').forEach(el=>{
    el.onclick=()=>{intent=el.dataset.intent;selectIntent(el);};
  });
  document.querySelectorAll('#roomGrid .room-option').forEach(o=>{
    o.onclick=()=>{selectRoom(o,'roomGrid');room=o.dataset.room;};
  });
  document.querySelectorAll('#newRoomGrid .room-option').forEach(o=>{
    o.onclick=()=>{selectRoom(o,'newRoomGrid');newRoom=o.dataset.room;};
  });
  document.getElementById('mainForm').onsubmit=e=>{e.preventDefault();sendMain();};
  document.getElementById('saveEditBtn').onclick=sendEdit;
  document.getElementById('backBtn').onclick=()=>toggleForms(true);
  document.getElementById('backFromEdit').onclick=()=>toggleForms(true);
}

function selectIntent(el){
  document.querySelectorAll('.intention-option').forEach(i=>i.classList.remove('selected'));
  el.classList.add('selected');
  selectedEvent=null;
  toggleForms();
}

function selectRoom(el,grid){
  document.querySelectorAll('#'+grid+' .room-option').forEach(i=>i.classList.remove('selected'));
  el.classList.add('selected');
}

function toggleForms(back){
  document.getElementById('intentScreen').style.display=back?'block':'none';
  document.getElementById('mainForm').style.display=intent==='book'&&!back?'block':'none';
  document.getElementById('editForm').style.display=intent==='edit'&&!back&&selectedEvent?'block':'none';
  document.getElementById('eventList').style.display=(intent==='cancel'||intent==='edit')&&!back&&!selectedEvent?'block':'none';
  if((intent==='cancel'||intent==='edit')&&!back&&!selectedEvent) loadEvents();
}

async function loadEvents(retry=0){
  if(!user){
    if(retry<5){
      log('User not loaded, retry '+retry);
      setTimeout(()=>loadEvents(retry+1),300);
    }else{
      log('Give up loading events');
    }
    return;
  }
  try{
    log('Fetching events for '+user.userId);
    const res=await fetch(`${appUrl}?userid=${encodeURIComponent(user.userId)}`);
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data=await res.json();
    renderEvents(data);
  }catch(e){log('Load events error: '+e);}
}

function renderEvents(list){
  const box=document.getElementById('eventList');
  if(!Array.isArray(list)||list.length===0){box.innerHTML='<div style="padding:6px">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</div>';return;}
  box.innerHTML=list.map(ev=>`
    <div class="room-option" data-id="${ev.id}">
      <b>${ev.title}</b><br>${ev.room}<br>${ev.date} ${ev.start}-${ev.end}
    </div>`).join('');
  box.querySelectorAll('.room-option').forEach(div=>{
    div.onclick=()=>selectEvent(div.dataset.id,list);
  });
}

function selectEvent(id,data){
  selectedEvent=data.find(x=>x.id===id);
  if(intent==='cancel'){
    const t=`Cancel Request\n‡πÄ‡∏û‡∏∑‡πà‡∏≠ ${selectedEvent.title} ‡∏´‡πâ‡∏≠‡∏á ${selectedEvent.room} ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${selectedEvent.date} ‡πÄ‡∏ß‡∏•‡∏≤ ${selectedEvent.start} - ${selectedEvent.end}`;
    sendMsg(t);
  }
  if(intent==='edit'){
    document.getElementById('editTitle').value=selectedEvent.title;
    document.getElementById('eventList').style.display='none';
    document.getElementById('editForm').style.display='block';
  }
}

function sendMain(){
  const title=document.getElementById('title').value.trim();
  const d=document.getElementById('date').value;
  const s=document.getElementById('start').value;
  const e=document.getElementById('end').value;
  const text=`Booking Request\n‡πÄ‡∏û‡∏∑‡πà‡∏≠ ${title} ‡∏´‡πâ‡∏≠‡∏á ${names[room]} ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${d} ‡πÄ‡∏ß‡∏•‡∏≤ ${s} - ${e}`;
  sendMsg(text);
}

function sendEdit(){
  const nd=document.getElementById('newDate').value;
  const ns=document.getElementById('newStart').value;
  const ne=document.getElementById('newEnd').value;
  const txt=`Edit Request\n‡πÄ‡∏û‡∏∑‡πà‡∏≠ ${selectedEvent.title} ‡∏´‡πâ‡∏≠‡∏á ${selectedEvent.room} ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${selectedEvent.date} ‡πÄ‡∏ß‡∏•‡∏≤ ${selectedEvent.start} - ${selectedEvent.end} ‡πÄ‡∏õ‡πá‡∏ô ${names[newRoom]} ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${nd} ‡πÄ‡∏ß‡∏•‡∏≤ ${ns} - ${ne}`;
  sendMsg(txt);
}

function sendMsg(text){
  if(!liff.isInClient()){log('Outside LINE, msg:\n'+text);return;}
  liff.sendMessages([{type:'text',text}])
      .then(()=>liff.closeWindow())
      .catch(e=>log('Send error: '+e.message));
}
</script>
</body>
</html>
